<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Routing - Monstache</title>
    <meta name="generator" content="Hugo 0.32-DEV" />

    
    <meta name="description" content="a go daemon which syncs mongodb to elasticsearch in neal realtime">
    
    <link rel="canonical" href="https://rwynn.github.io/monstache-site/index-meta/">
    
    <meta name="author" content="Ryan Wynn">
    

    <meta property="og:url" content="https://rwynn.github.io/monstache-site/index-meta/">
    <meta property="og:title" content="Monstache">
    <meta property="og:image" content="https://rwynn.github.io/images/monstache.png">
    <meta name="apple-mobile-web-app-title" content="Monstache">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://rwynn.github.io/monstache-site/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://rwynn.github.io/monstache-site/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://rwynn.github.io/monstache-site/fonts/icon.eot');
        src: url('https://rwynn.github.io/monstache-site/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://rwynn.github.io/monstache-site/fonts/icon.woff')
               format('woff'),
             url('https://rwynn.github.io/monstache-site/fonts/icon.ttf')
               format('truetype'),
             url('https://rwynn.github.io/monstache-site/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/application.css">
    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Work%20Sans:400,700|Source&#43;Code&#43;Pro">
    <style>
      body, input {
        font-family: 'Work Sans', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Source Code Pro', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://rwynn.github.io/monstache-site/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-indigo palette-accent-red">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Routing
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/rwynn" title="@rwynn on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/rwynn/monstache" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://rwynn.github.io/monstache-site/images/monstache.png">
        </div>
      
      <div class="name">
        <strong>Monstache <span class="version">3.4.2</span></strong>
        
          <br>
          rwynn/monstache
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/rwynn/monstache/releases" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/rwynn/monstache/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Monstache" href="https://rwynn.github.io/monstache-site/">
	
	Monstache
</a>



  
</li>



<li>
  
    



<a  title="Getting started" href="https://rwynn.github.io/monstache-site/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Options" href="https://rwynn.github.io/monstache-site/options/">
	
	Options
</a>



  
</li>



<li>
  
    



<a  title="Namespaces" href="https://rwynn.github.io/monstache-site/namespaces/">
	
	Namespaces
</a>



  
</li>



<li>
  
    



<a  title="Index Mapping" href="https://rwynn.github.io/monstache-site/index-mapping/">
	
	Index Mapping
</a>



  
</li>



<li>
  
    



<a  title="Transform and Filter" href="https://rwynn.github.io/monstache-site/transform-filter/">
	
	Transform and Filter
</a>



  
</li>



<li>
  
    



<a  title="Indexing GridFS Files" href="https://rwynn.github.io/monstache-site/gridfs/">
	
	Indexing GridFS Files
</a>



  
</li>



<li>
  
    



<a  title="Routing" href="https://rwynn.github.io/monstache-site/index-meta/">
	
	Routing
</a>



  
</li>



<li>
  
    



<a  title="Workers" href="https://rwynn.github.io/monstache-site/workers/">
	
	Workers
</a>



  
</li>



<li>
  
    



<a  title="High Availability" href="https://rwynn.github.io/monstache-site/high-availability/">
	
	High Availability
</a>



  
</li>



<li>
  
    



<a  title="Merge Patches" href="https://rwynn.github.io/monstache-site/merge-patches/">
	
	Merge Patches
</a>



  
</li>



<li>
  
    



<a  title="Systemd" href="https://rwynn.github.io/monstache-site/system-d/">
	
	Systemd
</a>



  
</li>



<li>
  
    



<a  title="HTTP Server" href="https://rwynn.github.io/monstache-site/http-server/">
	
	HTTP Server
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://rwynn.github.io/monstache-site/license/">
	
	License
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/rwynn" target="_blank" title="@rwynn on GitHub">
              @rwynn on GitHub
            </a>
          </li>
          

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Routing </h1>

			<p>Domain knowledge of your data can lead to better performance with a custom routing solution. Routing
is the process by which ElasticSearch determines which shard a document will reside in.  Monstache
supports user defined, or custom, routing of your MongoDB documents into ElasticSearch.</p>

<p>Consider an example where you have a <code>comments</code> collection in MongoDB which stores a comment and
its associated post identifier.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">use blog;
db.comments.insert({title<span style="color:#555">:</span> <span style="color:#c30">&#34;Did you read this?&#34;</span>, post_id<span style="color:#555">:</span> <span style="color:#c30">&#34;123&#34;</span>});
db.comments.insert({title<span style="color:#555">:</span> <span style="color:#c30">&#34;Yeah, it&#39;s good&#34;</span>, post_id<span style="color:#555">:</span> <span style="color:#c30">&#34;123&#34;</span>});</code></pre></div>
<p>In this case monstache will index those 2 documents in an index named <code>blog.comments</code> under the id
created by MongoDB.  When ElasticSearch routes a document to a shard, by default, it does so by hashing
the id of the document.  This means that as the number of comments on post <code>123</code> grows, each of the comments
will be distributed somewhat evenly between the available shards in the cluster.</p>

<p>Thus, when a query is performed searching among the comments for post <code>123</code> ElasticSearch will need to query
all of those shards just in case a comment happened to have been routed there.</p>

<p>This is where we can take advantage of the support in ElasticSearch and in monstache to do some intelligent
routing such that all comments for post <code>123</code> reside in the same shard.</p>

<p>First we need to tell monstache that we would like to do custom routing for this collection by setting <code>routing</code>
equal to true on a custom script for the namespace.  Then we need to add some metadata to the document telling
monstache how to route the document when indexing.  In this case we want to route by the <code>post_id</code> field.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[[script]]
namespace = <span style="color:#c30">&#34;blog.comments&#34;</span>
routing = <span style="color:#069;font-weight:bold">true</span>
script = <span style="color:#c30">&#34;&#34;&#34;
</span><span style="color:#c30">module.exports = function(doc) {
</span><span style="color:#c30">	doc._meta_monstache = { routing: doc.post_id };
</span><span style="color:#c30">	return doc;
</span><span style="color:#c30">}
</span><span style="color:#c30">&#34;&#34;&#34;</span></code></pre></div>
<p>Now when monstache indexes document for the collection <code>blog.comments</code> it will set the special <code>_routing</code> attribute
for the document on the index request such that ElasticSearch routes comments based on their corresponding post.</p>

<p>The <code>_meta_monstache</code> field is used only to inform monstache about routing and is not included in the source
document when indexing to ElasticSearch.</p>

<p>Now when we are searching for comments and we know the post id that the comment belongs to we can include that post
id in the request and make a search that normally queries all shards query only 1 shard.</p>

<pre><code>$ curl -H &quot;Content-Type:application/json&quot; -XGET 'http://localhost:9200/blog.comments/_search?routing=123' -d '
{
   &quot;query&quot;:{
      &quot;match_all&quot;:{}
   }
}'
</code></pre>

<p>You will notice in the response that only 1 shard was queried instead of all your shards.  Custom routing is great
way to reduce broadcast searches and thus get better performance.</p>

<p>The catch with custom routing is that you need to include the routing parameter on all insert, update, and delete
operations.  Insert and update is not a problem for monstache because the routing information will come from your
MongoDB document.  Deletes, however, pose a problem for monstache because when a delete occurs in MongoDB the
information in the oplog is limited to the id of the document that was deleted.  But monstache needs to know where the
document was originally routed in order to tell ElasticSearch where to look for it.</p>

<p>Monstache gets around this problem by using a lookup table that it stores in MongoDB at <code>monstache.meta</code>.  In this collection monstache stores
the routing information for each document with custom routing.  When a delete occurs monstache looks up the route
in this collection and forwards that information to ElasticSearch on the delete request.</p>

<p>For more information see <a href="https://www.elastic.co/blog/customizing-your-document-routing">Customizing Document Routing</a></p>

<p>In addition to letting your customize the shard routing for a specific document, you can also customize the elasticsearch
<code>index</code> and <code>type</code> using a script by putting the custom information in the meta attribute.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[[script]]
namespace = <span style="color:#c30">&#34;blog.comments&#34;</span>
routing = <span style="color:#069;font-weight:bold">true</span>
script = <span style="color:#c30">&#34;&#34;&#34;
</span><span style="color:#c30">module.exports = function(doc) {
</span><span style="color:#c30">	if (doc.score &gt;= 100) {
</span><span style="color:#c30">		// NOTE: prefix dynamic index with namespace for proper cleanup on drops
</span><span style="color:#c30">		doc._meta_monstache = { index: &#34;</span>blog.comments.highscore<span style="color:#c30">&#34;, type: &#34;</span>highScoreComment<span style="color:#c30">&#34;, routing: doc.post_id };
</span><span style="color:#c30">	} else {
</span><span style="color:#c30">		doc._meta_monstache = { routing: doc.post_id };
</span><span style="color:#c30">	}
</span><span style="color:#c30">	return doc;
</span><span style="color:#c30">}
</span><span style="color:#c30">&#34;&#34;&#34;</span></code></pre></div>
<hr />


			<aside class="copyright" role="note">
				
				&copy; 2018 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://rwynn.github.io/monstache-site/gridfs/" title="Indexing GridFS Files">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Indexing GridFS Files
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://rwynn.github.io/monstache-site/workers/" title="Workers">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Workers
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/rwynn.github.io\/monstache-site';
      var repo_id  = 'rwynn\/monstache';
    
    </script>

    <script src="https://rwynn.github.io/monstache-site/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

