<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Transform and Filter - Monstache</title>
    <meta name="generator" content="Hugo 0.26-DEV" />

    
    <meta name="description" content="a go daemon which syncs mongodb to elasticsearch in neal realtime">
    
    <link rel="canonical" href="https://rwynn.github.io/monstache-site/transform-filter/">
    
    <meta name="author" content="Ryan Wynn">
    

    <meta property="og:url" content="https://rwynn.github.io/monstache-site/transform-filter/">
    <meta property="og:title" content="Monstache">
    <meta property="og:image" content="https://rwynn.github.io/images/monstache.png">
    <meta name="apple-mobile-web-app-title" content="Monstache">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://rwynn.github.io/monstache-site/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://rwynn.github.io/monstache-site/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://rwynn.github.io/monstache-site/fonts/icon.eot');
        src: url('https://rwynn.github.io/monstache-site/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://rwynn.github.io/monstache-site/fonts/icon.woff')
               format('woff'),
             url('https://rwynn.github.io/monstache-site/fonts/icon.ttf')
               format('truetype'),
             url('https://rwynn.github.io/monstache-site/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/application.css">
    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://rwynn.github.io/monstache-site/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Work%20Sans:400,700|Source&#43;Code&#43;Pro">
    <style>
      body, input {
        font-family: 'Work Sans', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Source Code Pro', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://rwynn.github.io/monstache-site/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-indigo palette-accent-red">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Transform and Filter
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/rwynn" title="@rwynn on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>

</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/rwynn/monstache" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://rwynn.github.io/monstache-site/images/monstache.png">
        </div>
      
      <div class="name">
        <strong>Monstache <span class="version">3.1.1</span></strong>
        
          <br>
          rwynn/monstache
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/rwynn/monstache/releases" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/rwynn/monstache/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
	<hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Monstache" href="https://rwynn.github.io/monstache-site/">
	
	Monstache
</a>



  
</li>



<li>
  
    



<a  title="Getting started" href="https://rwynn.github.io/monstache-site/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Options" href="https://rwynn.github.io/monstache-site/options/">
	
	Options
</a>



  
</li>



<li>
  
    



<a  title="Namespaces" href="https://rwynn.github.io/monstache-site/namespaces/">
	
	Namespaces
</a>



  
</li>



<li>
  
    



<a  title="Index Mapping" href="https://rwynn.github.io/monstache-site/index-mapping/">
	
	Index Mapping
</a>



  
</li>



<li>
  
    



<a class="current" title="Transform and Filter" href="https://rwynn.github.io/monstache-site/transform-filter/">
	
	Transform and Filter
</a>


<ul id="scrollspy">
</ul>


  
</li>



<li>
  
    



<a  title="Indexing GridFS Files" href="https://rwynn.github.io/monstache-site/gridfs/">
	
	Indexing GridFS Files
</a>



  
</li>



<li>
  
    



<a  title="Routing" href="https://rwynn.github.io/monstache-site/index-meta/">
	
	Routing
</a>



  
</li>



<li>
  
    



<a  title="Workers" href="https://rwynn.github.io/monstache-site/workers/">
	
	Workers
</a>



  
</li>



<li>
  
    



<a  title="High Availability" href="https://rwynn.github.io/monstache-site/high-availability/">
	
	High Availability
</a>



  
</li>



<li>
  
    



<a  title="Merge Patches" href="https://rwynn.github.io/monstache-site/merge-patches/">
	
	Merge Patches
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://rwynn.github.io/monstache-site/license/">
	
	License
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">Author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/rwynn" target="_blank" title="@rwynn on GitHub">
              @rwynn on GitHub
            </a>
          </li>
          

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Transform and Filter </h1>

			

<p>monstache supports embedding user defined middleware between MongoDB and Elasticsearch.  middleware is able to transform documents,
drop documents, or define indexing metadata.  middleware may be written in either Javascript or in Golang as a plugin.  Golang plugins
require Go version 1.8 or greater. currently, you are able to use Javascript or Golang but not both (this may change in the future).</p>

<h2 id="golang">Golang</h2>

<p>monstache supports Golang 1.8 plugins on Linux.  To implement a plugin for monstache you simply need to implement a specific function signature,
use the go command to build a .so file for your plugin, and finally pass the path to your plugin .so file when running monstache.</p>

<p>plugins must import the package &ldquo;github.com/rwynn/monstache/monstachemap&rdquo;</p>

<p>plugins must implement a function named &ldquo;Map&rdquo; with the following signature</p>

<pre><code class="language-go">func Map(input *monstachemap.MapperPluginInput) (output *monstachemap.MapperPluginOutput, err error)
</code></pre>

<p>plugins can be compiled using</p>

<pre><code>go build -buildmode=plugin -o myplugin.so myplugin.go
</code></pre>

<p>to enable the plugin, start with monstache -mapper-plugin-path /path/to/myplugin.so</p>

<p>the following example plugin simply converts top level string values to uppercase</p>

<pre><code class="language-go">package main
import (
	&quot;github.com/rwynn/monstache/monstachemap&quot;
	&quot;strings&quot;
)
// a plugin to convert document values to uppercase
func Map(input *monstachemap.MapperPluginInput) (output *monstachemap.MapperPluginOutput, err error) {
	doc := input.Document
	for k, v := range doc {
		switch v.(type) {
		case string:
			doc[k] = strings.ToUpper(v.(string))
		}
	}
	output = &amp;monstachemap.MapperPluginOutput{Document: doc}
	return
}
</code></pre>

<p>the input parameter will contain information about the origin database and collection.  to drop the document (direct monstache not
to index it) set output.Drop = true.  to simply pass the original document through to Elasticsearch, set output.Passthrough = true</p>

<p>output.Index, output.Type, and output.Routing allow you to set the indexing metadata.</p>

<h2 id="javascript">Javascript</h2>

<h3 id="transformation">Transformation</h3>

<p>monstache uses the amazing <a href="https://github.com/robertkrimen/otto">otto</a> library to provide transformation at the document field
level in Javascript.  You can associate one javascript mapping function per mongodb collection.  These javascript functions are
added to your TOML config file, for example:</p>

<pre><code class="language-toml">[[script]]
namespace = &quot;mydb.mycollection&quot;
script = &quot;&quot;&quot;
var counter = 1;
module.exports = function(doc) {
	doc.foo += &quot;test&quot; + counter;
	counter++;
	return _.omit(doc, &quot;password&quot;, &quot;secret&quot;);
}
&quot;&quot;&quot;

[[script]]
namespace = &quot;anotherdb.anothercollection&quot;
script = &quot;&quot;&quot;
var counter = 1;
module.exports = function(doc) {
	doc.foo += &quot;test2&quot; + counter;
	counter++;
	return doc;
}
&quot;&quot;&quot;
</code></pre>

<p>The example TOML above configures 2 scripts. The first is applied to <code>mycollection</code> in <code>mydb</code> while the second is applied
to <code>anothercollection</code> in <code>anotherdb</code>.</p>

<p>You will notice that the multi-line string feature of TOML is used to assign a javascript snippet to the variable named
<code>script</code>.  The javascript assigned to script must assign a function to the exports property of the <code>module</code> object.  This
function will be passed the document from mongodb just before it is indexed in elasticsearch.  Inside the function you can
manipulate the document to drop fields, add fields, or augment the existing fields.</p>

<p>The <code>this</code> reference in the mapping function is assigned to the document from mongodb.</p>

<p>When the return value from the mapping function is an <code>object</code> then that mapped object is what actually gets indexed in elasticsearch.
For these purposes an object is a javascript non-primitive, excluding <code>Function</code>, <code>Array</code>, <code>String</code>, <code>Number</code>, <code>Boolean</code>, <code>Date</code>, <code>Error</code> and <code>RegExp</code>.</p>

<h3 id="filtering">Filtering</h3>

<p>If the return value from the mapping function is not an <code>object</code> per the definition above then the result is converted into a <code>boolean</code>
and if the boolean value is <code>false</code> then that indicates to monstache that you would not like to index the document. If the boolean value is <code>true</code> then
the original document from mongodb gets indexed in elasticsearch.</p>

<p>This allows you to return false or null if you have implemented soft deletes in mongodb.</p>

<pre><code class="language-toml">[[script]]
namespace = &quot;db.collection&quot;
script = &quot;&quot;&quot;
module.exports = function(doc) {
	if (!!doc.deletedAt) {
		return false;
	}
	return true;
}
&quot;&quot;&quot;
</code></pre>

<p>In the above example monstache will index any document except the ones with a <code>deletedAt</code> property.  If the document is first
inserted without a <code>deletedAt</code> property, but later updated to include the <code>deletedAt</code> property then monstache will remove the
previously indexed document from the elasticsearch index.</p>

<p>Note you could also return <code>doc</code> above instead of returning <code>true</code> and get the same result, however, it&rsquo;s a slight performance gain
to simply return <code>true</code> when not changing the document because you are not copying data in that case.</p>

<p>You may have noticed that in the first example above the exported mapping function closes over a var named <code>counter</code>.  You can
use closures to maintain state between invocations of your mapping function.</p>

<p>Finally, since Otto makes it so easy, the venerable <a href="http://underscorejs.org/">Underscore</a> library is included for you at
no extra charge.  Feel free to abuse the power of the <code>_</code>.</p>

<hr />


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://rwynn.github.io/monstache-site/index-mapping/" title="Index Mapping">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Index Mapping
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://rwynn.github.io/monstache-site/gridfs/" title="Indexing GridFS Files">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Indexing GridFS Files
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/rwynn.github.io\/monstache-site';
      var repo_id  = 'rwynn\/monstache';
    
    </script>

    <script src="https://rwynn.github.io/monstache-site/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

